openapi: 3.0.3
info:
  title: VaniFlow API
  version: 0.1.0
  description: |
    Decision-driven API for VaniFlow.
    AI logic (signal extraction) is separated from flow logic (condition evaluation) and action execution.
servers:
  - url: http://localhost:5000
    description: Local server
tags:
  - name: System
  - name: Auth
  - name: Flows
  - name: Conversations
  - name: AI Signals
  - name: Flow Engine
  - name: Actions
  - name: Tickets
  - name: Reservations
  - name: Knowledge
  - name: Summaries
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    flowId:
      name: flowId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    sessionId:
      name: sessionId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    ticketId:
      name: ticketId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    reservationId:
      name: reservationId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    kbId:
      name: kbId
      in: path
      required: true
      schema:
        type: string
        format: uuid
  schemas:
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: invalid_request
        message:
          type: string
          example: Required field missing.
        details:
          type: object
          additionalProperties: true
    Me:
      type: object
      required:
        - id
        - email
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        role:
          type: string
          enum: [owner, admin, agent]
    Channel:
      type: string
      enum: [voice, web_chat, whatsapp, instagram, crm]
    TicketPriority:
      type: string
      enum: [low, medium, high, critical]
    TicketStatus:
      type: string
      enum: [open, in_progress, resolved, closed]
    ReservationStatus:
      type: string
      enum: [pending, confirmed, cancelled]
    SignalExtraction:
      type: object
      required:
        - intent
        - intent_confidence
        - sentiment
        - tone_score
        - urgency_score
        - language
      properties:
        intent:
          type: string
          example: complaint
        intent_confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        sentiment:
          type: string
          enum: [negative, neutral, positive]
        tone_score:
          type: number
          format: float
          minimum: -1
          maximum: 1
        urgency_score:
          type: number
          format: float
          minimum: 0
          maximum: 1
        language:
          type: string
          example: en
        entities:
          type: object
          additionalProperties: true
    VoiceDecision:
      type: object
      required:
        - intent
        - sentiment_score
        - urgency_score
        - language
        - requires_human
        - confidence
      properties:
        intent:
          type: string
          enum: [complaint, reservation, inquiry, payment, support, other]
        sentiment_score:
          type: number
          format: float
          minimum: -1
          maximum: 1
        urgency_score:
          type: number
          format: float
          minimum: 0
          maximum: 1
        language:
          type: string
          example: en
        requires_human:
          type: boolean
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
    MicroserviceInvocation:
      type: object
      required: [service, mode, status, action, payload]
      properties:
        service:
          type: string
          example: ticketing-service
        mode:
          type: string
          enum: [local, remote]
        status:
          type: string
          enum: [success, failed]
        action:
          type: string
          example: create_ticket
        payload:
          type: object
          additionalProperties: true
    FlowNode:
      type: object
      required:
        - id
        - type
      properties:
        id:
          type: string
        type:
          type: string
          enum: [condition, action, terminal]
        condition:
          type: string
          description: Evaluated by flow engine against structured signals and context.
          example: intent == "complaint" && urgency_score > 0.8
        action:
          type: string
          enum: [create_ticket, escalate, make_reservation, call_webhook, respond]
        next:
          type: string
          nullable: true
        on_true:
          type: string
          nullable: true
        on_false:
          type: string
          nullable: true
        config:
          type: object
          additionalProperties: true
    FlowDefinition:
      type: object
      required:
        - start_node_id
        - nodes
      properties:
        start_node_id:
          type: string
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/FlowNode"
    Flow:
      type: object
      required:
        - id
        - name
        - status
        - definition
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        status:
          type: string
          enum: [draft, active, archived]
        version:
          type: integer
        definition:
          $ref: "#/components/schemas/FlowDefinition"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    ConversationSession:
      type: object
      required:
        - id
        - channel
        - status
      properties:
        id:
          type: string
          format: uuid
        channel:
          $ref: "#/components/schemas/Channel"
        flow_id:
          type: string
          format: uuid
          nullable: true
        user_ref:
          type: string
          description: External customer ID/phone/email from client system.
        status:
          type: string
          enum: [active, escalated, closed]
        created_at:
          type: string
          format: date-time
    Message:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [user, assistant, system, agent]
        content:
          type: string
        language:
          type: string
          example: en
        source:
          type: string
          enum: [text, voice_transcript]
    FlowEvaluationResult:
      type: object
      required:
        - reached_node_id
        - decision_trace
        - actions_to_execute
      properties:
        reached_node_id:
          type: string
        decision_trace:
          type: array
          items:
            type: object
            properties:
              node_id:
                type: string
              condition:
                type: string
              result:
                type: boolean
        actions_to_execute:
          type: array
          items:
            type: object
            required:
              - action
            properties:
              action:
                type: string
              payload:
                type: object
                additionalProperties: true
    Ticket:
      type: object
      required:
        - id
        - intent
        - priority
        - status
      properties:
        id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
        intent:
          type: string
        priority:
          $ref: "#/components/schemas/TicketPriority"
        tone_score:
          type: number
          format: float
        urgency_score:
          type: number
          format: float
        status:
          $ref: "#/components/schemas/TicketStatus"
        escalation_level:
          type: integer
          minimum: 0
        created_at:
          type: string
          format: date-time
    Reservation:
      type: object
      required:
        - id
        - status
      properties:
        id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
        service_type:
          type: string
          example: table_booking
        slot_start:
          type: string
          format: date-time
        slot_end:
          type: string
          format: date-time
        party_size:
          type: integer
          minimum: 1
        status:
          $ref: "#/components/schemas/ReservationStatus"
        created_at:
          type: string
          format: date-time
    KnowledgeDoc:
      type: object
      required:
        - id
        - title
        - status
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        source_url:
          type: string
          format: uri
          nullable: true
        status:
          type: string
          enum: [processing, ready, failed]
        created_at:
          type: string
          format: date-time
    Summary:
      type: object
      required:
        - session_id
        - key_issue
        - resolution
      properties:
        session_id:
          type: string
          format: uuid
        key_issue:
          type: string
        user_sentiment:
          type: string
          enum: [negative, neutral, positive]
        resolution:
          type: string
        actions_taken:
          type: array
          items:
            type: string
security:
  - bearerAuth: []
paths:
  /:
    get:
      tags: [System]
      security: []
      summary: Health check
      responses:
        "200":
          description: API is reachable.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Works!
  /me:
    get:
      tags: [Auth]
      summary: Get authenticated user
      responses:
        "200":
          description: Current user profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Me"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /flows:
    get:
      tags: [Flows]
      summary: List flow definitions
      responses:
        "200":
          description: List of flows
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Flow"
    post:
      tags: [Flows]
      summary: Create flow definition (draft)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, definition]
              properties:
                name:
                  type: string
                definition:
                  $ref: "#/components/schemas/FlowDefinition"
      responses:
        "201":
          description: Flow created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Flow"
  /flows/{flowId}:
    get:
      tags: [Flows]
      summary: Get flow by ID
      parameters:
        - $ref: "#/components/parameters/flowId"
      responses:
        "200":
          description: Flow details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Flow"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      tags: [Flows]
      summary: Update flow metadata or definition
      parameters:
        - $ref: "#/components/parameters/flowId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                status:
                  type: string
                  enum: [draft, active, archived]
                definition:
                  $ref: "#/components/schemas/FlowDefinition"
      responses:
        "200":
          description: Flow updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Flow"
  /flows/{flowId}/validate:
    post:
      tags: [Flows]
      summary: Validate flow graph and conditions without execution
      parameters:
        - $ref: "#/components/parameters/flowId"
      responses:
        "200":
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  errors:
                    type: array
                    items:
                      type: string
  /sessions:
    post:
      tags: [Conversations]
      summary: Create conversation session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [channel]
              properties:
                channel:
                  $ref: "#/components/schemas/Channel"
                flow_id:
                  type: string
                  format: uuid
                user_ref:
                  type: string
      responses:
        "201":
          description: Session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConversationSession"
  /sessions/{sessionId}:
    get:
      tags: [Conversations]
      summary: Get session state
      parameters:
        - $ref: "#/components/parameters/sessionId"
      responses:
        "200":
          description: Session details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConversationSession"
  /sessions/{sessionId}/messages:
    post:
      tags: [Conversations]
      summary: Add incoming user message (text or voice transcript)
      parameters:
        - $ref: "#/components/parameters/sessionId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Message"
      responses:
        "201":
          description: Message accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message_id:
                    type: string
                    format: uuid
  /sessions/{sessionId}/respond:
    post:
      tags: [Conversations]
      summary: End-to-end process (analyze -> evaluate flow -> execute actions -> generate response)
      parameters:
        - $ref: "#/components/parameters/sessionId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [input]
              properties:
                input:
                  type: string
                input_type:
                  type: string
                  enum: [text, voice_transcript]
                flow_id:
                  type: string
                  format: uuid
      responses:
        "200":
          description: Decision-driven assistant response
          content:
            application/json:
              schema:
                type: object
                properties:
                  signal_extraction:
                    $ref: "#/components/schemas/SignalExtraction"
                  flow_result:
                    $ref: "#/components/schemas/FlowEvaluationResult"
                  actions_result:
                    type: array
                    items:
                      type: object
                      additionalProperties: true
                  response_text:
                    type: string
                  response_language:
                    type: string
                    example: en
                  escalation_required:
                    type: boolean
  /ai/signals:analyze:
    post:
      tags: [AI Signals]
      summary: Extract structured AI signals only (no flow execution)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [input]
              properties:
                input:
                  type: string
                input_type:
                  type: string
                  enum: [text, voice_transcript]
                language_hint:
                  type: string
                  nullable: true
      responses:
        "200":
          description: Structured AI output
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SignalExtraction"
  /ai/voice-decision:
    post:
      tags: [AI Signals]
      summary: Voice input -> Sarvam STT/translation -> Gemini decision JSON
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [audio_base64]
              properties:
                audio_base64:
                  type: string
                  description: Base64 audio bytes. Data URI format is also accepted.
                mime_type:
                  type: string
                  example: audio/wav
                file_name:
                  type: string
                  example: input.wav
                session_id:
                  type: string
                  format: uuid
                metadata:
                  type: object
                  additionalProperties: true
      responses:
        "200":
          description: Voice was processed and classified.
          content:
            application/json:
              schema:
                type: object
                properties:
                  input:
                    type: object
                    properties:
                      source_text:
                        type: string
                      translated_text:
                        type: string
                      source_language:
                        type: string
                        nullable: true
                      target_language:
                        type: string
                        example: en
                  decision:
                    $ref: "#/components/schemas/VoiceDecision"
                  microservice:
                    $ref: "#/components/schemas/MicroserviceInvocation"
  /flow-engine/evaluate:
    post:
      tags: [Flow Engine]
      summary: Evaluate flow using structured signals (no AI call)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [flow_id, signals]
              properties:
                flow_id:
                  type: string
                  format: uuid
                signals:
                  $ref: "#/components/schemas/SignalExtraction"
                context:
                  type: object
                  additionalProperties: true
      responses:
        "200":
          description: Decision trace and actions to execute
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FlowEvaluationResult"
  /actions/execute:
    post:
      tags: [Actions]
      summary: Execute flow actions (ticket, reservation, escalation, webhook)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [session_id, actions]
              properties:
                session_id:
                  type: string
                  format: uuid
                actions:
                  type: array
                  items:
                    type: object
                    required: [action]
                    properties:
                      action:
                        type: string
                        enum: [create_ticket, escalate, make_reservation, call_webhook, respond]
                      payload:
                        type: object
                        additionalProperties: true
      responses:
        "200":
          description: Action execution results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object
                      additionalProperties: true
  /tickets:
    get:
      tags: [Tickets]
      summary: List tickets
      parameters:
        - name: status
          in: query
          schema:
            $ref: "#/components/schemas/TicketStatus"
      responses:
        "200":
          description: Ticket list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Ticket"
    post:
      tags: [Tickets]
      summary: Create ticket directly
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [intent, priority]
              properties:
                session_id:
                  type: string
                  format: uuid
                intent:
                  type: string
                priority:
                  $ref: "#/components/schemas/TicketPriority"
                tone_score:
                  type: number
                urgency_score:
                  type: number
      responses:
        "201":
          description: Ticket created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ticket"
  /tickets/{ticketId}:
    get:
      tags: [Tickets]
      summary: Get ticket by ID
      parameters:
        - $ref: "#/components/parameters/ticketId"
      responses:
        "200":
          description: Ticket details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ticket"
    patch:
      tags: [Tickets]
      summary: Update ticket state
      parameters:
        - $ref: "#/components/parameters/ticketId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  $ref: "#/components/schemas/TicketStatus"
                escalation_level:
                  type: integer
                priority:
                  $ref: "#/components/schemas/TicketPriority"
      responses:
        "200":
          description: Ticket updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ticket"
  /reservations:
    get:
      tags: [Reservations]
      summary: List reservations
      responses:
        "200":
          description: Reservation list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Reservation"
    post:
      tags: [Reservations]
      summary: Create reservation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [service_type, slot_start, slot_end]
              properties:
                session_id:
                  type: string
                  format: uuid
                service_type:
                  type: string
                slot_start:
                  type: string
                  format: date-time
                slot_end:
                  type: string
                  format: date-time
                party_size:
                  type: integer
      responses:
        "201":
          description: Reservation created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reservation"
  /reservations/{reservationId}:
    patch:
      tags: [Reservations]
      summary: Update reservation status
      parameters:
        - $ref: "#/components/parameters/reservationId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  $ref: "#/components/schemas/ReservationStatus"
      responses:
        "200":
          description: Reservation updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Reservation"
  /knowledge/docs:
    get:
      tags: [Knowledge]
      summary: List knowledge documents
      responses:
        "200":
          description: Documents list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/KnowledgeDoc"
    post:
      tags: [Knowledge]
      summary: Create knowledge document from text or URL
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                title:
                  type: string
                text:
                  type: string
                source_url:
                  type: string
                  format: uri
      responses:
        "202":
          description: Document accepted for chunking/embedding
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KnowledgeDoc"
  /knowledge/docs/{kbId}:
    get:
      tags: [Knowledge]
      summary: Get document status
      parameters:
        - $ref: "#/components/parameters/kbId"
      responses:
        "200":
          description: Document details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KnowledgeDoc"
  /knowledge/search:
    post:
      tags: [Knowledge]
      summary: Retrieve top-k relevant chunks (RAG retrieval only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query:
                  type: string
                top_k:
                  type: integer
                  default: 5
      responses:
        "200":
          description: Retrieved chunks
          content:
            application/json:
              schema:
                type: object
                properties:
                  chunks:
                    type: array
                    items:
                      type: object
                      properties:
                        doc_id:
                          type: string
                          format: uuid
                        text:
                          type: string
                        score:
                          type: number
                          format: float
  /sessions/{sessionId}/summary:
    post:
      tags: [Summaries]
      summary: Generate and persist conversation summary
      parameters:
        - $ref: "#/components/parameters/sessionId"
      responses:
        "200":
          description: Summary generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Summary"
    get:
      tags: [Summaries]
      summary: Get latest conversation summary
      parameters:
        - $ref: "#/components/parameters/sessionId"
      responses:
        "200":
          description: Latest summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Summary"
